<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XmlCompressor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HTML Compressor and Minifier</a> &gt; <a href="index.source.html" class="el_package">com.googlecode.htmlcompressor.compressor</a> &gt; <span class="el_source">XmlCompressor.java</span></div><h1>XmlCompressor.java</h1><pre class="source lang-java linenums">/**
 *    Copyright 2009-2017 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package com.googlecode.htmlcompressor.compressor;

import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Class that compresses given XML source by removing comments, extra spaces and line breaks while preserving content
 * within CDATA blocks.
<span class="fc" id="L27"> * </span>
 * @author &lt;a href=&quot;mailto:serg472@gmail.com&quot;&gt;Sergiy Kovalchuk&lt;/a&gt;
 */
<span class="fc" id="L30">public class XmlCompressor implements Compressor {</span>

    /** The enabled. */
    private boolean                enabled              = true;
<span class="fc" id="L34"></span>
    /** The remove comments. */
    // default settings
<span class="fc" id="L37">    private boolean                removeComments       = true;</span>

    /** The remove intertag spaces. */
    private boolean                removeIntertagSpaces = true;

    /** The Constant tempCdataBlock. */
    // temp replacements for preserved blocks
    protected static final String  TEMP_CD_DATA_BLOCK   = &quot;%%%COMPRESS~CDATA~{0,number,#}%%%&quot;;
<span class="fc" id="L45"></span>
    /** The Constant cdataPattern. */
    // compiled regex patterns
    protected static final Pattern cdataPattern         = Pattern.compile(&quot;&lt;!\\[CDATA\\[.*?\\]\\]&gt;&quot;,
<span class="fc" id="L49">            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);</span>

    /** The Constant commentPattern. */
    protected static final Pattern commentPattern       = Pattern.compile(&quot;&lt;!--.*?--&gt;&quot;,
<span class="fc" id="L53">            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);</span>

    /** The Constant intertagPattern. */
    protected static final Pattern intertagPattern      = Pattern.compile(&quot;&gt;\\s+&lt;&quot;,
<span class="fc" id="L57">            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);</span>

    /** The Constant tagEndSpacePattern. */
    protected static final Pattern tagEndSpacePattern   = Pattern.compile(&quot;(&lt;(?:[^&gt;]+?))(?:\\s+?)(/?&gt;)&quot;,
<span class="fc" id="L61">            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);</span>

    /** The Constant multispacePattern. */
    protected static final Pattern multispacePattern    = Pattern.compile(&quot;\\s+(?=[^&lt;]*?&gt;)&quot;,
<span class="fc" id="L65">            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);</span>

    /** The Constant tagPropertyPattern. */
    protected static final Pattern tagPropertyPattern   = Pattern.compile(&quot;(\\s\\w+)\\s*=\\s*(?=[^&lt;]*?&gt;)&quot;,
<span class="fc" id="L69">            Pattern.CASE_INSENSITIVE);</span>

    /** The Constant tempCdataPattern. */
    protected static final Pattern tempCdataPattern     = Pattern.compile(&quot;%%%COMPRESS~CDATA~(\\d+?)%%%&quot;,
            Pattern.DOTALL | Pattern.CASE_INSENSITIVE);

    /**
     * The main method that compresses given XML source and returns compressed result.
     * 
     * @param xml
     *            XML content to compress
     * @return compressed content.
<span class="pc bpc" id="L81" title="2 of 6 branches missed.">     */</span>
<span class="fc" id="L82">    @Override</span>
    public String compress(String xml) {
        if (!enabled || xml == null || xml.length() == 0) {
            return xml;
<span class="fc" id="L86">        }</span>

        // preserved block containers
<span class="fc" id="L89">        List&lt;String&gt; cdataBlocks = new ArrayList&lt;&gt;();</span>

        // preserve blocks
<span class="fc" id="L92">        xml = preserveBlocks(xml, cdataBlocks);</span>

        // process pure xml
<span class="fc" id="L95">        xml = processXml(xml);</span>

<span class="fc" id="L97">        // return preserved blocks</span>
        xml = returnBlocks(xml, cdataBlocks);

        return xml.trim();
    }

    /**
     * Preserve blocks.
     *
     * @param xml
     *            the xml
     * @param cdataBlocks
     *            the cdata blocks
     * @return the string
<span class="fc" id="L111">     */</span>
<span class="fc" id="L112">    protected String preserveBlocks(String xml, List&lt;String&gt; cdataBlocks) {</span>
<span class="fc" id="L113">        // preserve CDATA blocks</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        Matcher matcher = cdataPattern.matcher(xml);</span>
<span class="fc" id="L115">        int index = 0;</span>
<span class="fc" id="L116">        StringBuffer sb = new StringBuffer();</span>
        while (matcher.find()) {
<span class="fc" id="L118">            cdataBlocks.add(matcher.group(0));</span>
<span class="fc" id="L119">            matcher.appendReplacement(sb, MessageFormat.format(TEMP_CD_DATA_BLOCK, index++));</span>
        }
<span class="fc" id="L121">        matcher.appendTail(sb);</span>
        xml = sb.toString();

        return xml;
    }

    /**
     * Return blocks.
     *
     * @param xml
     *            the xml
     * @param cdataBlocks
     *            the cdata blocks
     * @return the string
<span class="fc" id="L135">     */</span>
<span class="fc" id="L136">    protected String returnBlocks(String xml, List&lt;String&gt; cdataBlocks) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        // put CDATA blocks back</span>
<span class="fc" id="L138">        Matcher matcher = tempCdataPattern.matcher(xml);</span>
<span class="fc" id="L139">        StringBuffer sb = new StringBuffer();</span>
        while (matcher.find()) {
<span class="fc" id="L141">            matcher.appendReplacement(sb,</span>
<span class="fc" id="L142">                    Matcher.quoteReplacement(cdataBlocks.get(Integer.parseInt(matcher.group(1)))));</span>
        }
<span class="fc" id="L144">        matcher.appendTail(sb);</span>
        xml = sb.toString();

        return xml;
    }

    /**
     * Process xml.
     *
     * @param xml
     *            the xml
     * @return the string
<span class="fc" id="L156">     */</span>
    protected String processXml(String xml) {
        // remove comments
<span class="fc" id="L159">        xml = removeComments(xml);</span>

        // remove inter-tag spaces
<span class="fc" id="L162">        xml = removeIntertagSpaces(xml);</span>

<span class="fc" id="L164">        // remove unneeded spaces inside tags</span>
        xml = removeSpacesInsideTags(xml);

        return xml;
    }

    /**
     * Removes the spaces inside tags.
     *
     * @param xml
     *            the xml
     * @return the string
<span class="fc" id="L176">     */</span>
    protected String removeSpacesInsideTags(String xml) {
        // replace miltiple spaces inside tags with single spaces
<span class="fc" id="L179">        xml = multispacePattern.matcher(xml).replaceAll(&quot; &quot;);</span>

        // remove spaces around equal sign inside tags
<span class="fc" id="L182">        xml = tagPropertyPattern.matcher(xml).replaceAll(&quot;$1=&quot;);</span>
<span class="fc" id="L183"></span>
        // remove ending spaces inside tags
        xml = tagEndSpacePattern.matcher(xml).replaceAll(&quot;$1$2&quot;);
        return xml;
    }

    /**
     * Removes the intertag spaces.
     *
     * @param xml
     *            the xml
     * @return the string
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">     */</span>
<span class="fc" id="L196">    protected String removeIntertagSpaces(String xml) {</span>
        // remove inter-tag spaces
<span class="fc" id="L198">        if (removeIntertagSpaces) {</span>
            xml = intertagPattern.matcher(xml).replaceAll(&quot;&gt;&lt;&quot;);
        }
        return xml;
    }

    /**
     * Removes the comments.
     *
     * @param xml
     *            the xml
     * @return the string
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">     */</span>
<span class="fc" id="L211">    protected String removeComments(String xml) {</span>
        // remove comments
<span class="fc" id="L213">        if (removeComments) {</span>
            xml = commentPattern.matcher(xml).replaceAll(&quot;&quot;);
        }
        return xml;
    }

    /**
     * Returns &lt;code&gt;true&lt;/code&gt; if compression is enabled.
     * 
<span class="nc" id="L222">     * @return &lt;code&gt;true&lt;/code&gt; if compression is enabled.</span>
     */
    public boolean isEnabled() {
        return enabled;
    }

    /**
     * If set to &lt;code&gt;false&lt;/code&gt; all compression will be bypassed. Might be useful for testing purposes. Default is
     * &lt;code&gt;true&lt;/code&gt;.
     * 
     * @param enabled
<span class="fc" id="L233">     *            set &lt;code&gt;false&lt;/code&gt; to bypass all compression</span>
<span class="fc" id="L234">     */</span>
    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
    }

    /**
     * Returns &lt;code&gt;true&lt;/code&gt; if all XML comments will be removed.
     * 
<span class="nc" id="L242">     * @return &lt;code&gt;true&lt;/code&gt; if all XML comments will be removed</span>
     */
    public boolean isRemoveComments() {
        return removeComments;
    }

    /**
     * If set to &lt;code&gt;true&lt;/code&gt; all XML comments will be removed. Default is &lt;code&gt;true&lt;/code&gt;.
     * 
     * @param removeComments
<span class="fc" id="L252">     *            set &lt;code&gt;true&lt;/code&gt; to remove all XML comments</span>
<span class="fc" id="L253">     */</span>
    public void setRemoveComments(boolean removeComments) {
        this.removeComments = removeComments;
    }

    /**
     * Returns &lt;code&gt;true&lt;/code&gt; if all inter-tag whitespace characters will be removed.
     * 
<span class="nc" id="L261">     * @return &lt;code&gt;true&lt;/code&gt; if all inter-tag whitespace characters will be removed.</span>
     */
    public boolean isRemoveIntertagSpaces() {
        return removeIntertagSpaces;
    }

    /**
     * If set to &lt;code&gt;true&lt;/code&gt; all inter-tag whitespace characters will be removed. Default is &lt;code&gt;true&lt;/code&gt;.
     * 
     * @param removeIntertagSpaces
<span class="fc" id="L271">     *            set &lt;code&gt;true&lt;/code&gt; to remove all inter-tag whitespace characters</span>
<span class="fc" id="L272">     */</span>
    public void setRemoveIntertagSpaces(boolean removeIntertagSpaces) {
        this.removeIntertagSpaces = removeIntertagSpaces;
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>