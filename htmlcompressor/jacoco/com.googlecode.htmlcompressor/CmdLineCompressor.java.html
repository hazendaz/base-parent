<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CmdLineCompressor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HTML Compressor and Minifier</a> &gt; <a href="index.source.html" class="el_package">com.googlecode.htmlcompressor</a> &gt; <span class="el_source">CmdLineCompressor.java</span></div><h1>CmdLineCompressor.java</h1><pre class="source lang-java linenums">/**
 *    Copyright 2009-2017 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package com.googlecode.htmlcompressor;

import jargs.gnu.CmdLineParser;
import jargs.gnu.CmdLineParser.Option;
import jargs.gnu.CmdLineParser.OptionException;

import java.io.BufferedReader;
import java.io.Closeable;
import java.io.File;
import java.io.FileFilter;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.net.URL;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Stack;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.regex.PatternSyntaxException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.javascript.jscomp.CompilationLevel;
import com.google.javascript.jscomp.SourceFile;
import com.googlecode.htmlcompressor.analyzer.HtmlAnalyzer;
import com.googlecode.htmlcompressor.compressor.ClosureJavaScriptCompressor;
import com.googlecode.htmlcompressor.compressor.Compressor;
import com.googlecode.htmlcompressor.compressor.HtmlCompressor;
import com.googlecode.htmlcompressor.compressor.XmlCompressor;

/**
 * Wrapper for HTML and XML compressor classes that allows using them from a command line.
 * 
 * &lt;p&gt;
 * Usage: &lt;code&gt;java -jar htmlcompressor.jar [options] [input]&lt;/code&gt;
 * &lt;p&gt;
 * To view a list of all available parameters please run with &lt;code&gt;-?&lt;/code&gt; option:
 * &lt;p&gt;
 * &lt;code&gt;java -jar htmlcompressor.jar -?&lt;/code&gt;
 * 
 * @author &lt;a href=&quot;mailto:serg472@gmail.com&quot;&gt;Sergiy Kovalchuk&lt;/a&gt;
 */
<span class="nc" id="L67">public class CmdLineCompressor {</span>

    /** The Constant logger. */
<span class="nc" id="L70">    private static final Logger  logger     = LoggerFactory.getLogger(CmdLineCompressor.class);</span>

    /** The Constant urlPattern. */
    private static final Pattern urlPattern = Pattern.compile(&quot;^https?://.*$&quot;, Pattern.CASE_INSENSITIVE);

    /** The help opt. */
    private boolean              helpOpt;

    /** The analyze opt. */
    private boolean              analyzeOpt;

    /** The charset opt. */
    private Charset              charsetOpt;

    /** The output filename opt. */
    private String               outputFilenameOpt;

    /** The patterns filename opt. */
    private String               patternsFilenameOpt;

    /** The type opt. */
    private String               typeOpt;

    /** The filemask opt. */
    private String               filemaskOpt;

    /** The recursive opt. */
    private boolean              recursiveOpt;

    /** The preserve comments opt. */
    private boolean              preserveCommentsOpt;

    /** The preserve intertag spaces opt. */
    private boolean              preserveIntertagSpacesOpt;

    /** The preserve multi spaces opt. */
    private boolean              preserveMultiSpacesOpt;

    /** The remove intertag spaces opt. */
    private boolean              removeIntertagSpacesOpt;

    /** The remove quotes opt. */
    private boolean              removeQuotesOpt;

    /** The remove surrounding spaces opt. */
    private String               removeSurroundingSpacesOpt;

    /** The preserve line breaks opt. */
    private boolean              preserveLineBreaksOpt;

    /** The preserve php tags opt. */
    private boolean              preservePhpTagsOpt;

    /** The preserve server script tags opt. */
    private boolean              preserveServerScriptTagsOpt;

    /** The preserve ssi tags opt. */
    private boolean              preserveSsiTagsOpt;

    /** The compress js opt. */
    private boolean              compressJsOpt;

    /** The compress css opt. */
    private boolean              compressCssOpt;

    /** The js compressor opt. */
    private String               jsCompressorOpt;

    /** The simple doctype opt. */
    private boolean              simpleDoctypeOpt;

    /** The remove script attributes opt. */
    private boolean              removeScriptAttributesOpt;

    /** The remove style attributes opt. */
    private boolean              removeStyleAttributesOpt;

    /** The remove link attributes opt. */
    private boolean              removeLinkAttributesOpt;

    /** The remove form attributes opt. */
    private boolean              removeFormAttributesOpt;

    /** The remove input attributes opt. */
    private boolean              removeInputAttributesOpt;

    /** The simple boolean attributes opt. */
    private boolean              simpleBooleanAttributesOpt;

    /** The remove java script protocol opt. */
    private boolean              removeJavaScriptProtocolOpt;

    /** The remove http protocol opt. */
    private boolean              removeHttpProtocolOpt;

    /** The remove https protocol opt. */
    private boolean              removeHttpsProtocolOpt;

    /** The nomunge opt. */
    private boolean              nomungeOpt;

    /** The linebreak opt. */
    private int                  linebreakOpt;

    /** The preserve semi opt. */
    private boolean              preserveSemiOpt;

    /** The disable optimizations opt. */
    private boolean              disableOptimizationsOpt;

    /** The closure opt level opt. */
    private String               closureOptLevelOpt;

    /** The closure custom externs only opt. */
    private boolean              closureCustomExternsOnlyOpt;

    /** The closure externs opt. */
    private List&lt;String&gt;         closureExternsOpt;

    /** The file args opt. */
    private List&lt;String&gt;         fileArgsOpt;

    /**
     * Instantiates a new cmd line compressor.
     *
<span class="nc" id="L195">     * @param args</span>
<span class="nc" id="L196">     *            the args</span>
     */
<span class="nc" id="L198">    public CmdLineCompressor(String[] args) {</span>
<span class="nc" id="L199">        CmdLineParser parser = new CmdLineParser();</span>
<span class="nc" id="L200"></span>
<span class="nc" id="L201">        Option helpOption = parser.addBooleanOption('h', &quot;help&quot;);</span>
<span class="nc" id="L202">        Option helpOptAlt = parser.addBooleanOption('?', &quot;help_alt&quot;);</span>
<span class="nc" id="L203">        Option analyzeOption = parser.addBooleanOption('a', &quot;analyze&quot;);</span>
<span class="nc" id="L204">        Option recursiveOption = parser.addBooleanOption('r', &quot;recursive&quot;);</span>
<span class="nc" id="L205">        Option charsetOption = parser.addStringOption('c', &quot;charset&quot;);</span>
<span class="nc" id="L206">        Option outputFilenameOption = parser.addStringOption('o', &quot;output&quot;);</span>
<span class="nc" id="L207">        Option patternsFilenameOption = parser.addStringOption('p', &quot;preserve&quot;);</span>
<span class="nc" id="L208">        Option typeOption = parser.addStringOption('t', &quot;type&quot;);</span>
<span class="nc" id="L209">        Option filemaskOption = parser.addStringOption('m', &quot;mask&quot;);</span>
<span class="nc" id="L210">        Option preserveCommentsOption = parser.addBooleanOption(&quot;preserve-comments&quot;);</span>
<span class="nc" id="L211">        Option preserveIntertagSpacesOption = parser.addBooleanOption(&quot;preserve-intertag-spaces&quot;);</span>
<span class="nc" id="L212">        Option preserveMultiSpacesOption = parser.addBooleanOption(&quot;preserve-multi-spaces&quot;);</span>
<span class="nc" id="L213">        Option removeIntertagSpacesOption = parser.addBooleanOption(&quot;remove-intertag-spaces&quot;);</span>
<span class="nc" id="L214">        Option removeSurroundingSpacesOption = parser.addStringOption(&quot;remove-surrounding-spaces&quot;);</span>
<span class="nc" id="L215">        Option removeQuotesOption = parser.addBooleanOption(&quot;remove-quotes&quot;);</span>
<span class="nc" id="L216">        Option preserveLineBreaksOption = parser.addBooleanOption(&quot;preserve-line-breaks&quot;);</span>
<span class="nc" id="L217">        Option preservePhpTagsOption = parser.addBooleanOption(&quot;preserve-php&quot;);</span>
<span class="nc" id="L218">        Option preserveServerScriptTagsOption = parser.addBooleanOption(&quot;preserve-server-script&quot;);</span>
<span class="nc" id="L219">        Option preserveSsiTagsOption = parser.addBooleanOption(&quot;preserve-ssi&quot;);</span>
        Option compressJsOption = parser.addBooleanOption(&quot;compress-js&quot;);
<span class="nc" id="L221">        Option compressCssOption = parser.addBooleanOption(&quot;compress-css&quot;);</span>
<span class="nc" id="L222">        Option jsCompressorOption = parser.addStringOption(&quot;js-compressor&quot;);</span>
<span class="nc" id="L223"></span>
<span class="nc" id="L224">        Option simpleDoctypeOption = parser.addBooleanOption(&quot;simple-doctype&quot;);</span>
<span class="nc" id="L225">        Option removeScriptAttributesOption = parser.addBooleanOption(&quot;remove-script-attr&quot;);</span>
<span class="nc" id="L226">        Option removeStyleAttributesOption = parser.addBooleanOption(&quot;remove-style-attr&quot;);</span>
<span class="nc" id="L227">        Option removeLinkAttributesOption = parser.addBooleanOption(&quot;remove-link-attr&quot;);</span>
<span class="nc" id="L228">        Option removeFormAttributesOption = parser.addBooleanOption(&quot;remove-form-attr&quot;);</span>
<span class="nc" id="L229">        Option removeInputAttributesOption = parser.addBooleanOption(&quot;remove-input-attr&quot;);</span>
<span class="nc" id="L230">        Option simpleBooleanAttributesOption = parser.addBooleanOption(&quot;simple-bool-attr&quot;);</span>
        Option removeJavaScriptProtocolOption = parser.addBooleanOption(&quot;remove-js-protocol&quot;);
<span class="nc" id="L232">        Option removeHttpProtocolOption = parser.addBooleanOption(&quot;remove-http-protocol&quot;);</span>
<span class="nc" id="L233">        Option removeHttpsProtocolOption = parser.addBooleanOption(&quot;remove-https-protocol&quot;);</span>
<span class="nc" id="L234"></span>
<span class="nc" id="L235">        Option nomungeOption = parser.addBooleanOption(&quot;nomunge&quot;);</span>
        Option linebreakOption = parser.addStringOption(&quot;line-break&quot;);
<span class="nc" id="L237">        Option preserveSemiOption = parser.addBooleanOption(&quot;preserve-semi&quot;);</span>
<span class="nc" id="L238">        Option disableOptimizationsOption = parser.addBooleanOption(&quot;disable-optimizations&quot;);</span>
<span class="nc" id="L239"></span>
        Option closureOptLevelOption = parser.addStringOption(&quot;closure-opt-level&quot;);
        Option closureCustomExternsOnlyOption = parser.addBooleanOption(&quot;closure-custom-externs-only&quot;);
<span class="nc" id="L242">        Option closureExternsOption = parser.addStringOption(&quot;closure-externs&quot;);</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">        try {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            parser.parse(args);</span>
<span class="nc" id="L246"></span>
<span class="nc" id="L247">            this.helpOpt = (Boolean) parser.getOptionValue(helpOption, false)</span>
<span class="nc" id="L248">                    || (Boolean) parser.getOptionValue(helpOptAlt, false);</span>
<span class="nc" id="L249">            this.analyzeOpt = (Boolean) parser.getOptionValue(analyzeOption, false);</span>
<span class="nc" id="L250">            this.recursiveOpt = (Boolean) parser.getOptionValue(recursiveOption, false);</span>
<span class="nc" id="L251">            this.charsetOpt = Charset.forName((String) parser.getOptionValue(charsetOption, &quot;UTF-8&quot;));</span>
<span class="nc" id="L252">            this.outputFilenameOpt = (String) parser.getOptionValue(outputFilenameOption);</span>
<span class="nc" id="L253">            this.patternsFilenameOpt = (String) parser.getOptionValue(patternsFilenameOption);</span>
<span class="nc" id="L254">            this.typeOpt = (String) parser.getOptionValue(typeOption);</span>
<span class="nc" id="L255">            this.filemaskOpt = (String) parser.getOptionValue(filemaskOption);</span>
<span class="nc" id="L256">            this.preserveCommentsOpt = (Boolean) parser.getOptionValue(preserveCommentsOption, false);</span>
<span class="nc" id="L257">            this.preserveIntertagSpacesOpt = (Boolean) parser.getOptionValue(preserveIntertagSpacesOption, false);</span>
<span class="nc" id="L258">            this.preserveMultiSpacesOpt = (Boolean) parser.getOptionValue(preserveMultiSpacesOption, false);</span>
<span class="nc" id="L259">            this.removeIntertagSpacesOpt = (Boolean) parser.getOptionValue(removeIntertagSpacesOption, false);</span>
<span class="nc" id="L260">            this.removeQuotesOpt = (Boolean) parser.getOptionValue(removeQuotesOption, false);</span>
<span class="nc" id="L261">            this.preserveLineBreaksOpt = (Boolean) parser.getOptionValue(preserveLineBreaksOption, false);</span>
<span class="nc" id="L262">            this.preservePhpTagsOpt = (Boolean) parser.getOptionValue(preservePhpTagsOption, false);</span>
<span class="nc" id="L263">            this.preserveServerScriptTagsOpt = (Boolean) parser.getOptionValue(preserveServerScriptTagsOption, false);</span>
<span class="nc" id="L264">            this.preserveSsiTagsOpt = (Boolean) parser.getOptionValue(preserveSsiTagsOption, false);</span>
            this.compressJsOpt = (Boolean) parser.getOptionValue(compressJsOption, false);
<span class="nc" id="L266">            this.compressCssOpt = (Boolean) parser.getOptionValue(compressCssOption, false);</span>
<span class="nc" id="L267">            this.jsCompressorOpt = (String) parser.getOptionValue(jsCompressorOption, HtmlCompressor.JS_COMPRESSOR_YUI);</span>
<span class="nc" id="L268"></span>
<span class="nc" id="L269">            this.simpleDoctypeOpt = (Boolean) parser.getOptionValue(simpleDoctypeOption, false);</span>
<span class="nc" id="L270">            this.removeScriptAttributesOpt = (Boolean) parser.getOptionValue(removeScriptAttributesOption, false);</span>
<span class="nc" id="L271">            this.removeStyleAttributesOpt = (Boolean) parser.getOptionValue(removeStyleAttributesOption, false);</span>
<span class="nc" id="L272">            this.removeLinkAttributesOpt = (Boolean) parser.getOptionValue(removeLinkAttributesOption, false);</span>
<span class="nc" id="L273">            this.removeFormAttributesOpt = (Boolean) parser.getOptionValue(removeFormAttributesOption, false);</span>
<span class="nc" id="L274">            this.removeInputAttributesOpt = (Boolean) parser.getOptionValue(removeInputAttributesOption, false);</span>
<span class="nc" id="L275">            this.simpleBooleanAttributesOpt = (Boolean) parser.getOptionValue(simpleBooleanAttributesOption, false);</span>
            this.removeJavaScriptProtocolOpt = (Boolean) parser.getOptionValue(removeJavaScriptProtocolOption, false);
<span class="nc" id="L277">            this.removeHttpProtocolOpt = (Boolean) parser.getOptionValue(removeHttpProtocolOption, false);</span>
<span class="nc" id="L278">            this.removeHttpsProtocolOpt = (Boolean) parser.getOptionValue(removeHttpsProtocolOption, false);</span>
<span class="nc" id="L279"></span>
<span class="nc" id="L280">            this.nomungeOpt = (Boolean) parser.getOptionValue(nomungeOption, false);</span>
            this.linebreakOpt = (Integer) parser.getOptionValue(linebreakOption, -1);
<span class="nc" id="L282">            this.preserveSemiOpt = (Boolean) parser.getOptionValue(preserveSemiOption, false);</span>
            this.disableOptimizationsOpt = (Boolean) parser.getOptionValue(disableOptimizationsOption, false);
<span class="nc" id="L284"></span>
            this.closureOptLevelOpt = (String) parser.getOptionValue(closureOptLevelOption,
<span class="nc" id="L286">                    ClosureJavaScriptCompressor.COMPILATION_LEVEL_SIMPLE);</span>
            this.closureCustomExternsOnlyOpt = (Boolean) parser.getOptionValue(closureCustomExternsOnlyOption, false);
<span class="nc" id="L288"></span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            this.closureExternsOpt = parser.getOptionValues(closureExternsOption);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed."></span>
<span class="nc" id="L291">            this.removeSurroundingSpacesOpt = (String) parser.getOptionValue(removeSurroundingSpacesOption);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (this.removeSurroundingSpacesOpt != null) {</span>
<span class="nc" id="L293">                if (&quot;min&quot;.equalsIgnoreCase(this.removeSurroundingSpacesOpt)) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                    this.removeSurroundingSpacesOpt = HtmlCompressor.BLOCK_TAGS_MIN;</span>
<span class="nc" id="L295">                } else if (&quot;max&quot;.equalsIgnoreCase(this.removeSurroundingSpacesOpt)) {</span>
                    this.removeSurroundingSpacesOpt = HtmlCompressor.BLOCK_TAGS_MAX;
                } else if (&quot;all&quot;.equalsIgnoreCase(this.removeSurroundingSpacesOpt)) {
                    this.removeSurroundingSpacesOpt = HtmlCompressor.ALL_TAGS;
                }
<span class="nc" id="L300">            }</span>

            // input file
<span class="nc bnc" id="L303" title="All 2 branches missed.">            this.fileArgsOpt = parser.getRemainingArgs();</span>

            // charset
<span class="nc bnc" id="L306" title="All 2 branches missed.">            this.charsetOpt = Charset.isSupported(this.charsetOpt.name()) ? this.charsetOpt : StandardCharsets.UTF_8;</span>
<span class="nc bnc" id="L307" title="All 2 branches missed."></span>
<span class="nc" id="L308">            // look for &quot;/?&quot;</span>
<span class="nc" id="L309">            for (int i = 0; i &lt; args.length; i++) {</span>
                if (&quot;/?&quot;.equals(args[i])) {
                    this.helpOpt = true;
                    break;
<span class="nc" id="L313">                }</span>
<span class="nc" id="L314">            }</span>
<span class="nc" id="L315"></span>
<span class="nc" id="L316">        } catch (OptionException e) {</span>
<span class="nc" id="L317">            logger.info(&quot;{}&quot; + e.getMessage());</span>
            logger.trace(&quot;&quot;, e);
<span class="nc" id="L319">            printUsage();</span>
        }

    }

    /**
     * The main method.
     *
     * @param args
<span class="nc" id="L328">     *            the arguments</span>
<span class="nc" id="L329">     */</span>
<span class="nc" id="L330">    public static void main(String[] args) {</span>
        CmdLineCompressor cmdLineCompressor = new CmdLineCompressor(args);
        cmdLineCompressor.process();
    }

    /**
     * Process.
     */
    public void process() {
<span class="nc bnc" id="L339" title="All 2 branches missed.">        try {</span>
<span class="nc" id="L340"></span>
<span class="nc" id="L341">            // help</span>
            if (helpOpt) {
                printUsage();
                return;
<span class="nc" id="L345">            }</span>
<span class="nc bnc" id="L346" title="All 6 branches missed."></span>
<span class="nc" id="L347">            // type</span>
            String type = typeOpt;
            if (type != null &amp;&amp; !&quot;html&quot;.equalsIgnoreCase(type) &amp;&amp; !&quot;xml&quot;.equalsIgnoreCase(type)) {
<span class="nc bnc" id="L350" title="All 2 branches missed.">                throw new IllegalArgumentException(&quot;Unknown type: &quot; + type);</span>
            }
<span class="nc bnc" id="L352" title="All 2 branches missed."></span>
<span class="nc" id="L353">            if (fileArgsOpt.isEmpty()) {</span>
                // html by default for stdin
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (type == null) {</span>
                    type = &quot;html&quot;;
<span class="nc bnc" id="L357" title="All 2 branches missed.">                }</span>
<span class="nc" id="L358">            } else if (type == null) {</span>
                // detect type from extension
<span class="nc" id="L360">                if (fileArgsOpt.get(0).toLowerCase().endsWith(&quot;.xml&quot;)) {</span>
                    type = &quot;xml&quot;;
                } else {
                    type = &quot;html&quot;;
<span class="nc bnc" id="L364" title="All 2 branches missed.">                }</span>
            }
<span class="nc" id="L366"></span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            if (analyzeOpt) {</span>
                // analyzer mode
<span class="nc bnc" id="L369" title="All 2 branches missed.">                HtmlAnalyzer analyzer = new HtmlAnalyzer(</span>
<span class="nc" id="L370">                        HtmlCompressor.JS_COMPRESSOR_CLOSURE.equalsIgnoreCase(jsCompressorOpt)</span>
                                ? HtmlCompressor.JS_COMPRESSOR_CLOSURE : HtmlCompressor.JS_COMPRESSOR_YUI);
<span class="nc bnc" id="L372" title="All 2 branches missed.">                analyzer.analyze(readResource(buildReader(fileArgsOpt.isEmpty() ? null : fileArgsOpt.get(0))));</span>
<span class="nc" id="L373">            } else {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                // compression mode</span>
<span class="nc" id="L375">                Compressor compressor = &quot;xml&quot;.equalsIgnoreCase(type) ? createXmlCompressor() : createHtmlCompressor();</span>
<span class="nc" id="L376">                Map&lt;String, String&gt; ioMap = buildInputOutputMap();</span>
<span class="nc" id="L377">                for (Map.Entry&lt;String, String&gt; entry : ioMap.entrySet()) {</span>
                    writeResource(compressor.compress(readResource(buildReader(entry.getKey()))),
                            buildWriter(entry.getValue()));
<span class="nc" id="L380">                }</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            }</span>
<span class="nc" id="L382"></span>
        } catch (NoClassDefFoundError e) {
            if (HtmlCompressor.JS_COMPRESSOR_CLOSURE.equalsIgnoreCase(jsCompressorOpt)) {
                logger.info(&quot;ERROR: For JavaScript compression using Google Closure Compiler\n&quot;
<span class="nc" id="L386">                        + &quot;additional jar file called compiler.jar must be present\n&quot;</span>
                        + &quot;in the same directory as HtmlCompressor jar&quot;);
            } else {
<span class="nc" id="L389">                logger.info(&quot;ERROR: For CSS or JavaScript compression using YUICompressor additional jar file \n&quot;</span>
<span class="nc" id="L390">                        + &quot;called yuicompressor.jar must be present\n&quot; + &quot;in the same directory as HtmlCompressor jar&quot;);</span>
<span class="nc" id="L391">            }</span>
<span class="nc" id="L392">            logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L393">        } catch (OptionException e) {</span>
<span class="nc" id="L394">            logger.info(&quot;{}&quot; + e.getMessage());</span>
<span class="nc" id="L395">            logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L396">            printUsage();</span>
<span class="nc" id="L397">        } catch (IOException | IllegalArgumentException e) {</span>
            logger.info(&quot;{}&quot; + e.getMessage());
<span class="nc" id="L399">            logger.trace(&quot;&quot;, e);</span>
        }

    }

    /**
     * Creates the html compressor.
     *
     * @return the compressor
     * @throws OptionException
     *             the option exception
<span class="nc" id="L410">     */</span>
    private Compressor createHtmlCompressor() throws OptionException {

<span class="nc" id="L413">        boolean useClosureCompressor = HtmlCompressor.JS_COMPRESSOR_CLOSURE.equalsIgnoreCase(jsCompressorOpt);</span>

        // custom preserve patterns
<span class="nc bnc" id="L416" title="All 2 branches missed.">        List&lt;Pattern&gt; preservePatterns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L417"></span>
        // predefined
        if (preservePhpTagsOpt) {
<span class="nc bnc" id="L420" title="All 2 branches missed.">            preservePatterns.add(HtmlCompressor.PHP_TAG_PATTERN);</span>
<span class="nc" id="L421">        }</span>

        if (preserveServerScriptTagsOpt) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">            preservePatterns.add(HtmlCompressor.SERVER_SCRIPT_TAG_PATTERN);</span>
<span class="nc" id="L425">        }</span>

        if (preserveSsiTagsOpt) {
<span class="nc bnc" id="L428" title="All 2 branches missed.">            preservePatterns.add(HtmlCompressor.SERVER_SIDE_INCLUDE_PATTERN);</span>
        }
<span class="nc" id="L430"></span>
<span class="nc" id="L431">        if (patternsFilenameOpt != null) {</span>

<span class="nc" id="L433">            try (FileInputStream stream = new FileInputStream(patternsFilenameOpt);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">                    BufferedReader patternsIn = new BufferedReader(new InputStreamReader(stream, charsetOpt))) {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed."></span>
                String line = null;
<span class="nc" id="L437">                while ((line = patternsIn.readLine()) != null) {</span>
<span class="nc" id="L438">                    if (line.length() &gt; 0) {</span>
<span class="nc" id="L439">                        try {</span>
<span class="nc" id="L440">                            preservePatterns.add(Pattern.compile(line));</span>
<span class="nc" id="L441">                        } catch (PatternSyntaxException e) {</span>
<span class="nc" id="L442">                            logger.trace(&quot;&quot;, e);</span>
                            throw new IllegalArgumentException(
                                    &quot;Regular expression compilation error: &quot; + e.getMessage());
<span class="nc bnc" id="L445" title="All 16 branches missed.">                        }</span>
<span class="nc" id="L446">                    }</span>
<span class="nc" id="L447">                }</span>
<span class="nc" id="L448">            } catch (IOException e) {</span>
                logger.trace(&quot;&quot;, e);
                throw new IllegalArgumentException(&quot;Unable to read custom pattern definitions file: &quot; + e.getMessage());
            }
<span class="nc" id="L452">        }</span>

<span class="nc bnc" id="L454" title="All 2 branches missed.">        // set compressor options</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        HtmlCompressor htmlCompressor = new HtmlCompressor();</span>
<span class="nc" id="L456"></span>
<span class="nc" id="L457">        htmlCompressor.setRemoveComments(!preserveCommentsOpt);</span>
<span class="nc" id="L458">        htmlCompressor.setRemoveMultiSpaces(!preserveMultiSpacesOpt);</span>
<span class="nc" id="L459">        htmlCompressor.setRemoveIntertagSpaces(removeIntertagSpacesOpt);</span>
<span class="nc" id="L460">        htmlCompressor.setRemoveQuotes(removeQuotesOpt);</span>
        htmlCompressor.setPreserveLineBreaks(preserveLineBreaksOpt);
<span class="nc" id="L462">        htmlCompressor.setCompressJavaScript(compressJsOpt);</span>
<span class="nc" id="L463">        htmlCompressor.setCompressCss(compressCssOpt);</span>
<span class="nc" id="L464"></span>
<span class="nc" id="L465">        htmlCompressor.setSimpleDoctype(simpleDoctypeOpt);</span>
<span class="nc" id="L466">        htmlCompressor.setRemoveScriptAttributes(removeScriptAttributesOpt);</span>
<span class="nc" id="L467">        htmlCompressor.setRemoveStyleAttributes(removeStyleAttributesOpt);</span>
<span class="nc" id="L468">        htmlCompressor.setRemoveLinkAttributes(removeLinkAttributesOpt);</span>
<span class="nc" id="L469">        htmlCompressor.setRemoveFormAttributes(removeFormAttributesOpt);</span>
<span class="nc" id="L470">        htmlCompressor.setRemoveInputAttributes(removeInputAttributesOpt);</span>
<span class="nc" id="L471">        htmlCompressor.setSimpleBooleanAttributes(simpleBooleanAttributesOpt);</span>
<span class="nc" id="L472">        htmlCompressor.setRemoveJavaScriptProtocol(removeJavaScriptProtocolOpt);</span>
        htmlCompressor.setRemoveHttpProtocol(removeHttpProtocolOpt);
<span class="nc" id="L474">        htmlCompressor.setRemoveHttpsProtocol(removeHttpsProtocolOpt);</span>
        htmlCompressor.setRemoveSurroundingSpaces(removeSurroundingSpacesOpt);
<span class="nc" id="L476"></span>
<span class="nc" id="L477">        htmlCompressor.setPreservePatterns(preservePatterns);</span>
<span class="nc" id="L478"></span>
<span class="nc" id="L479">        htmlCompressor.setYuiJsNoMunge(nomungeOpt);</span>
<span class="nc" id="L480">        htmlCompressor.setYuiJsPreserveAllSemiColons(preserveSemiOpt);</span>
        htmlCompressor.setYuiJsDisableOptimizations(disableOptimizationsOpt);
        htmlCompressor.setYuiJsLineBreak(linebreakOpt);
<span class="nc bnc" id="L483" title="All 4 branches missed.">        htmlCompressor.setYuiCssLineBreak(linebreakOpt);</span>
<span class="nc" id="L484"></span>
        // switch js compressor to closure
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (compressJsOpt &amp;&amp; useClosureCompressor) {</span>
<span class="nc" id="L487">            ClosureJavaScriptCompressor closureCompressor = new ClosureJavaScriptCompressor();</span>
<span class="nc" id="L488"></span>
            if (closureOptLevelOpt.equalsIgnoreCase(ClosureJavaScriptCompressor.COMPILATION_LEVEL_ADVANCED)) {
                closureCompressor.setCompilationLevel(CompilationLevel.ADVANCED_OPTIMIZATIONS);
<span class="nc bnc" id="L491" title="All 2 branches missed.">                closureCompressor.setCustomExternsOnly(closureCustomExternsOnlyOpt);</span>
<span class="nc" id="L492"></span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                // get externs</span>
<span class="nc" id="L494">                if (!closureExternsOpt.isEmpty()) {</span>
<span class="nc" id="L495">                    List&lt;SourceFile&gt; externs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L496">                    for (String externFile : closureExternsOpt) {</span>
<span class="nc" id="L497">                        externs.add(SourceFile.fromFile(externFile));</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                    }</span>
<span class="nc" id="L499">                    closureCompressor.setExterns(externs);</span>
                }
<span class="nc" id="L501">            } else if (closureOptLevelOpt.equalsIgnoreCase(ClosureJavaScriptCompressor.COMPILATION_LEVEL_WHITESPACE)) {</span>
                closureCompressor.setCompilationLevel(CompilationLevel.WHITESPACE_ONLY);
            } else {
<span class="nc" id="L504">                closureCompressor.setCompilationLevel(CompilationLevel.SIMPLE_OPTIMIZATIONS);</span>
            }

<span class="nc" id="L507">            htmlCompressor.setJavaScriptCompressor(closureCompressor);</span>
        }

        return htmlCompressor;
    }

    /**
     * Creates the xml compressor.
     *
     * @return the compressor
     * @throws IllegalArgumentException
     *             the illegal argument exception
     * @throws OptionException
<span class="nc" id="L520">     *             the option exception</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">     */</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">    private Compressor createXmlCompressor() throws IllegalArgumentException, OptionException {</span>
        XmlCompressor xmlCompressor = new XmlCompressor();
<span class="nc" id="L524">        xmlCompressor.setRemoveComments(!preserveCommentsOpt);</span>
        xmlCompressor.setRemoveIntertagSpaces(!preserveIntertagSpacesOpt);

        return xmlCompressor;
    }

    /**
     * Builds the input output map.
     *
     * @return the map
     * @throws IllegalArgumentException
     *             the illegal argument exception
     * @throws IOException
<span class="nc" id="L537">     *             Signals that an I/O exception has occurred.</span>
     */
<span class="nc" id="L539">    private Map&lt;String, String&gt; buildInputOutputMap() throws IllegalArgumentException, IOException {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L541"></span>
        File outpuFile = null;
        if (outputFilenameOpt != null) {
<span class="nc bnc" id="L544" title="All 4 branches missed.">            outpuFile = new File(outputFilenameOpt);</span>
<span class="nc" id="L545"></span>
            // make dirs
<span class="nc" id="L547">            if (outputFilenameOpt.endsWith(&quot;/&quot;) || outputFilenameOpt.endsWith(&quot;\\&quot;)) {</span>
                outpuFile.mkdirs();
            } else {
                (new File(outpuFile.getCanonicalFile().getParent())).mkdirs();
<span class="nc bnc" id="L551" title="All 6 branches missed.">            }</span>
<span class="nc" id="L552">        }</span>

        if (fileArgsOpt.size() &gt; 1 &amp;&amp; (outpuFile == null || !outpuFile.isDirectory())) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">            throw new IllegalArgumentException(&quot;Output must be a directory and end with a slash (/)&quot;);</span>
<span class="nc" id="L556">        }</span>

<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (fileArgsOpt.isEmpty()) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            map.put(null, outputFilenameOpt);</span>
<span class="nc" id="L560">        } else {</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">            for (int i = 0; i &lt; fileArgsOpt.size(); i++) {</span>
                if (!urlPattern.matcher(fileArgsOpt.get(i)).matches()) {
<span class="nc bnc" id="L563" title="All 4 branches missed.">                    File inputFile = new File(fileArgsOpt.get(i));</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">                    if (inputFile.isDirectory()) {</span>
                        // is dir
<span class="nc bnc" id="L566" title="All 2 branches missed.">                        if (outpuFile != null &amp;&amp; outpuFile.isDirectory()) {</span>
<span class="nc" id="L567">                            if (!recursiveOpt) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                                // non-recursive</span>
<span class="nc" id="L569">                                for (File file : inputFile</span>
<span class="nc" id="L570">                                        .listFiles(new CompressorFileFilter(typeOpt, filemaskOpt, false))) {</span>
<span class="nc" id="L571">                                    if (!file.isDirectory()) {</span>
<span class="nc" id="L572">                                        String from = file.getCanonicalPath();</span>
                                        String to = from.replaceFirst(escRegEx(inputFile.getCanonicalPath()),
                                                Matcher.quoteReplacement(outpuFile.getCanonicalPath()));
                                        map.put(from, to);
                                    }
<span class="nc" id="L577">                                }</span>
<span class="nc" id="L578">                            } else {</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                                // recursive</span>
<span class="nc" id="L580">                                Stack&lt;File&gt; fileStack = new Stack&lt;&gt;();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                                fileStack.push(inputFile);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">                                while (!fileStack.isEmpty()) {</span>
<span class="nc" id="L583">                                    File child = fileStack.pop();</span>
<span class="nc" id="L584">                                    if (child.isDirectory()) {</span>
                                        for (File f : child
<span class="nc bnc" id="L586" title="All 2 branches missed.">                                                .listFiles(new CompressorFileFilter(typeOpt, filemaskOpt, true))) {</span>
<span class="nc" id="L587">                                            fileStack.push(f);</span>
<span class="nc" id="L588">                                        }</span>
<span class="nc" id="L589">                                    } else if (child.isFile()) {</span>
<span class="nc" id="L590">                                        String from = child.getCanonicalPath();</span>
                                        String to = from.replaceFirst(escRegEx(inputFile.getCanonicalPath()),
<span class="nc" id="L592">                                                Matcher.quoteReplacement(outpuFile.getCanonicalPath()));</span>
                                        map.put(from, to);
<span class="nc" id="L594">                                        // make dirs</span>
<span class="nc" id="L595">                                        (new File((new File(to)).getCanonicalFile().getParent())).mkdirs();</span>
                                    }
<span class="nc" id="L597">                                }</span>
                            }
                        } else {
                            throw new IllegalArgumentException(&quot;Output must be a directory and end with a slash (/)&quot;);
<span class="nc bnc" id="L601" title="All 4 branches missed.">                        }</span>
<span class="nc" id="L602">                    } else {</span>
<span class="nc" id="L603">                        // is file</span>
<span class="nc" id="L604">                        if (outpuFile != null &amp;&amp; outpuFile.isDirectory()) {</span>
<span class="nc" id="L605">                            String from = inputFile.getCanonicalPath();</span>
<span class="nc" id="L606">                            String to = from.replaceFirst(</span>
<span class="nc" id="L607">                                    escRegEx(inputFile.getCanonicalFile().getParentFile().getCanonicalPath()),</span>
<span class="nc" id="L608">                                    Matcher.quoteReplacement(outpuFile.getCanonicalPath()));</span>
                            map.put(fileArgsOpt.get(i), to);
                        } else {
                            map.put(fileArgsOpt.get(i), outputFilenameOpt);
<span class="nc" id="L612">                        }</span>

<span class="nc bnc" id="L614" title="All 6 branches missed.">                    }</span>
<span class="nc" id="L615">                } else {</span>
                    // is url
<span class="nc" id="L617">                    if (fileArgsOpt.size() == 1 &amp;&amp; (outpuFile == null || !outpuFile.isDirectory())) {</span>
                        map.put(fileArgsOpt.get(i), outputFilenameOpt);
                    } else {
                        throw new IllegalArgumentException(
                                &quot;Input URL should be single and cannot have directory as output&quot;);
                    }
                }
<span class="nc" id="L624">            }</span>
        }

        return map;
    }

    /**
     * Builds the reader.
     *
     * @param filename
     *            the filename
     * @return the buffered reader
     * @throws IOException
<span class="nc bnc" id="L637" title="All 2 branches missed.">     *             Signals that an I/O exception has occurred.</span>
<span class="nc" id="L638">     */</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">    private BufferedReader buildReader(String filename) throws IOException {</span>
<span class="nc" id="L640">        if (filename == null) {</span>
            return new BufferedReader(new InputStreamReader(System.in, charsetOpt));
<span class="nc" id="L642">        } else if (urlPattern.matcher(filename).matches()) {</span>
            return new BufferedReader(new InputStreamReader((new URL(filename)).openConnection().getInputStream()));
        } else {
            return new BufferedReader(new InputStreamReader(new FileInputStream(filename), charsetOpt));
        }
    }

    /**
     * Builds the writer.
     *
     * @param filename
     *            the filename
     * @return the writer
     * @throws IOException
<span class="nc bnc" id="L656" title="All 2 branches missed.">     *             Signals that an I/O exception has occurred.</span>
<span class="nc" id="L657">     */</span>
    private Writer buildWriter(String filename) throws IOException {
<span class="nc" id="L659">        if (filename == null) {</span>
            return new OutputStreamWriter(System.out, charsetOpt);
        } else {
            return new OutputStreamWriter(new FileOutputStream(filename), charsetOpt);
        }
    }

    /**
     * Read resource.
     *
     * @param input
     *            the input
     * @return the string
     * @throws IOException
<span class="nc" id="L673">     *             Signals that an I/O exception has occurred.</span>
     */
<span class="nc" id="L675">    private String readResource(BufferedReader input) throws IOException {</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">        StringBuilder source = new StringBuilder();</span>
<span class="nc" id="L677">        try {</span>
<span class="nc" id="L678">            String line = null;</span>
            while ((line = input.readLine()) != null) {
                source.append(line);
<span class="nc" id="L681">                source.append(System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc" id="L682">            }</span>
<span class="nc" id="L683">        } finally {</span>
            closeStream(input);
        }
        return source.toString();
    }

    /**
     * Write resource.
     *
     * @param content
     *            the content
     * @param output
     *            the output
     * @throws IOException
     *             Signals that an I/O exception has occurred.
<span class="nc" id="L698">     */</span>
    private void writeResource(String content, Writer output) throws IOException {
<span class="nc" id="L700">        try {</span>
<span class="nc" id="L701">            output.write(content);</span>
<span class="nc" id="L702">        } finally {</span>
            closeStream(output);
        }
    }

    /**
     * Close stream.
     *
     * @param stream
<span class="nc bnc" id="L711" title="All 2 branches missed.">     *            the stream</span>
     */
<span class="nc" id="L713">    private void closeStream(Closeable stream) {</span>
<span class="nc" id="L714">        if (stream != null) {</span>
<span class="nc" id="L715">            try {</span>
<span class="nc" id="L716">                stream.close();</span>
            } catch (IOException e) {
<span class="nc" id="L718">                logger.trace(&quot;&quot;, e);</span>
            }
        }
    }

    /**
     * Esc reg ex.
     *
     * @param inStr
     *            the in str
<span class="nc" id="L728">     * @return the string</span>
     */
    private String escRegEx(String inStr) {
        return inStr.replaceAll(&quot;([\\\\*+\\[\\](){}\\$.?\\^|])&quot;, &quot;\\\\$1&quot;);
    }

    /**
<span class="nc" id="L735">     * Prints the usage.</span>
     */
    private void printUsage() {
        logger.info(&quot;Usage: java -jar htmlcompressor.jar [options] [input]\n\n&quot;

                + &quot;[input]                        URL, filename, directory, or space separated list\n&quot;
                + &quot;                               of files and directories to compress.\n&quot;
                + &quot;                               If none provided reads from &lt;stdin&gt;\n\n&quot;

                + &quot;Global Options:\n&quot; + &quot; -?, /?, -h, --help            Displays this help screen\n&quot;
                + &quot; -t, --type &lt;html|xml&gt;         If not provided autodetects from file extension\n&quot;
                + &quot; -r, --recursive               Process files inside subdirectories\n&quot;
                + &quot; -c, --charset &lt;charset&gt;       Charset for reading files, UTF-8 by default\n&quot;
                + &quot; -m, --mask &lt;filemask&gt;         Filter input files inside directories by mask\n&quot;
                + &quot; -o, --output &lt;path&gt;           Filename or directory for compression results.\n&quot;
                + &quot;                               If none provided outputs result to &lt;stdout&gt;\n&quot;
                + &quot; -a, --analyze                 Tries different settings and displays report.\n&quot;
                + &quot;                               All settings except --js-compressor are ignored\n\n&quot;

                + &quot;XML Compression Options:\n&quot; + &quot; --preserve-comments           Preserve comments\n&quot;
                + &quot; --preserve-intertag-spaces    Preserve intertag spaces\n\n&quot;

                + &quot;HTML Compression Options:\n&quot; + &quot; --preserve-comments           Preserve comments\n&quot;
                + &quot; --preserve-multi-spaces       Preserve multiple spaces\n&quot;
                + &quot; --preserve-line-breaks        Preserve line breaks\n&quot;
                + &quot; --remove-intertag-spaces      Remove intertag spaces\n&quot;
                + &quot; --remove-quotes               Remove unneeded quotes\n&quot;
                + &quot; --simple-doctype              Change doctype to &lt;!DOCTYPE html&gt;\n&quot;
                + &quot; --remove-style-attr           Remove TYPE attribute from STYLE tags\n&quot;
                + &quot; --remove-link-attr            Remove TYPE attribute from LINK tags\n&quot;
                + &quot; --remove-script-attr          Remove TYPE and LANGUAGE from SCRIPT tags\n&quot;
                + &quot; --remove-form-attr            Remove METHOD=\&quot;GET\&quot; from FORM tags\n&quot;
                + &quot; --remove-input-attr           Remove TYPE=\&quot;TEXT\&quot; from INPUT tags\n&quot;
                + &quot; --simple-bool-attr            Remove values from boolean tag attributes\n&quot;
                + &quot; --remove-js-protocol          Remove \&quot;javascript:\&quot; from inline event handlers\n&quot;
                + &quot; --remove-http-protocol        Remove \&quot;http:\&quot; from tag attributes\n&quot;
                + &quot; --remove-https-protocol       Remove \&quot;https:\&quot; from tag attributes\n&quot;
                + &quot; --remove-surrounding-spaces &lt;min|max|all|custom_list&gt;\n&quot;
                + &quot;                               Predefined or custom comma separated list of tags\n&quot;
                + &quot; --compress-js                 Enable inline JavaScript compression\n&quot;
                + &quot; --compress-css                Enable inline CSS compression using YUICompressor\n&quot;
                + &quot; --js-compressor &lt;yui|closure&gt; Switch inline JavaScript compressor between\n&quot;
                + &quot;                               YUICompressor (default) and Closure Compiler\n\n&quot;

                + &quot;JavaScript Compression Options for YUI Compressor:\n&quot;
                + &quot; --nomunge                     Minify only, do not obfuscate\n&quot;
                + &quot; --preserve-semi               Preserve all semicolons\n&quot;
                + &quot; --disable-optimizations       Disable all micro optimizations\n&quot;
                + &quot; --line-break &lt;column num&gt;     Insert a line break after the specified column\n\n&quot;

                + &quot;JavaScript Compression Options for Google Closure Compiler:\n&quot;
                + &quot; --closure-opt-level &lt;simple|advanced|whitespace&gt;\n&quot;
                + &quot;                               Sets level of optimization (simple by default)\n&quot;
                + &quot; --closure-externs &lt;file&gt;      Sets custom externs file, repeat for each file\n&quot;
                + &quot; --closure-custom-externs-only Disable default built-in externs\n\n&quot;

                + &quot;CSS Compression Options for YUI Compressor:\n&quot;
                + &quot; --line-break &lt;column num&gt;     Insert a line break after the specified column\n\n&quot;

                + &quot;Custom Block Preservation Options:\n&quot; + &quot; --preserve-php                Preserve &lt;?php ... ?&gt; tags\n&quot;
                + &quot; --preserve-server-script      Preserve &lt;% ... %&gt; tags\n&quot;
                + &quot; --preserve-ssi                Preserve &lt;!--# ... --&gt; tags\n&quot;
                + &quot; -p, --preserve &lt;path&gt;         Read regular expressions that define\n&quot;
                + &quot;                               custom preservation rules from a file\n\n&quot;

                + &quot;Please note that if you enable CSS or JavaScript compression, additional\n&quot;
                + &quot;YUI Compressor or Google Closure Compiler jar files must be present\n&quot;
<span class="nc" id="L802">                + &quot;in the same directory as this jar.&quot;</span>

        );
    }

    /**
     * The Class CompressorFileFilter.
     */
    private class CompressorFileFilter implements FileFilter {

        /** The filemask pattern. */
        private Pattern filemaskPattern;

        /** The with dirs. */
        private boolean withDirs;

        /**
         * Instantiates a new compressor file filter.
         *
         * @param type
         *            the type
         * @param filemask
         *            the filemask
<span class="nc" id="L825">         * @param withDirs</span>
         *            the with dirs
<span class="nc" id="L827">         */</span>
        public CompressorFileFilter(String type, String filemask, boolean withDirs) {
<span class="nc bnc" id="L829" title="All 2 branches missed."></span>
<span class="nc bnc" id="L830" title="All 4 branches missed.">            this.withDirs = withDirs;</span>
<span class="nc" id="L831"></span>
            if (filemask == null) {
<span class="nc" id="L833">                if (type != null &amp;&amp; &quot;xml&quot;.equalsIgnoreCase(type)) {</span>
                    filemaskPattern = Pattern.compile(&quot;^.*\\.xml$&quot;, Pattern.CASE_INSENSITIVE);
                } else {
                    filemaskPattern = Pattern.compile(&quot;^.*\\.html?$&quot;, Pattern.CASE_INSENSITIVE);
<span class="nc" id="L837">                }</span>
<span class="nc" id="L838">            } else {</span>
<span class="nc" id="L839">                // turn mask into regexp</span>
<span class="nc" id="L840">                filemask = filemask.replaceAll(escRegEx(&quot;.&quot;), Matcher.quoteReplacement(&quot;\\.&quot;));</span>
<span class="nc" id="L841">                filemask = filemask.replaceAll(escRegEx(&quot;*&quot;), Matcher.quoteReplacement(&quot;.*&quot;));</span>
                filemask = filemask.replaceAll(escRegEx(&quot;?&quot;), Matcher.quoteReplacement(&quot;.&quot;));
<span class="nc" id="L843">                filemask = filemask.replaceAll(escRegEx(&quot;;&quot;), Matcher.quoteReplacement(&quot;$|^&quot;));</span>
                filemask = &quot;^&quot; + filemask + &quot;$&quot;;
<span class="nc" id="L845"></span>
                filemaskPattern = Pattern.compile(filemask, Pattern.CASE_INSENSITIVE);
            }
        }
<span class="nc bnc" id="L849" title="All 2 branches missed."></span>
        @Override
<span class="nc bnc" id="L851" title="All 2 branches missed.">        public boolean accept(File file) {</span>
<span class="nc" id="L852">            if (!withDirs) {</span>
                // take only matching non-dirs
                if (!file.isDirectory()) {
                    return filemaskPattern.matcher(file.getName()).matches();
<span class="nc bnc" id="L856" title="All 4 branches missed.">                }</span>
            } else {
<span class="nc" id="L858">                // take matching files and dirs</span>
                return file.isDirectory() || filemaskPattern.matcher(file.getName()).matches();
            }
            return false;
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>