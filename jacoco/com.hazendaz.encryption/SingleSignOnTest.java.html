<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SingleSignOnTest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fileupload</a> &gt; <a href="index.source.html" class="el_package">com.hazendaz.encryption</a> &gt; <span class="el_source">SingleSignOnTest.java</span></div><h1>SingleSignOnTest.java</h1><pre class="source lang-java linenums">package com.hazendaz.encryption;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.security.Security;
import java.util.Iterator;

import org.bouncycastle.bcpg.CompressionAlgorithmTags;
import org.bouncycastle.bcpg.SymmetricKeyAlgorithmTags;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.openpgp.PGPCompressedData;
import org.bouncycastle.openpgp.PGPCompressedDataGenerator;
import org.bouncycastle.openpgp.PGPEncryptedDataGenerator;
import org.bouncycastle.openpgp.PGPEncryptedDataList;
import org.bouncycastle.openpgp.PGPException;
import org.bouncycastle.openpgp.PGPLiteralData;
import org.bouncycastle.openpgp.PGPObjectFactory;
import org.bouncycastle.openpgp.PGPOnePassSignatureList;
import org.bouncycastle.openpgp.PGPPrivateKey;
import org.bouncycastle.openpgp.PGPPublicKey;
import org.bouncycastle.openpgp.PGPPublicKeyEncryptedData;
import org.bouncycastle.openpgp.PGPSecretKey;
import org.bouncycastle.openpgp.PGPSecretKeyRingCollection;
import org.bouncycastle.openpgp.PGPUtil;
import org.bouncycastle.openpgp.bc.BcPGPObjectFactory;
import org.bouncycastle.openpgp.bc.BcPGPSecretKeyRingCollection;
import org.bouncycastle.openpgp.operator.bc.BcPBESecretKeyDecryptorBuilder;
import org.bouncycastle.openpgp.operator.bc.BcPGPDataEncryptorBuilder;
import org.bouncycastle.openpgp.operator.bc.BcPGPDigestCalculatorProvider;
import org.bouncycastle.openpgp.operator.bc.BcPublicKeyDataDecryptorFactory;
import org.bouncycastle.openpgp.operator.bc.BcPublicKeyKeyEncryptionMethodGenerator;
import org.bouncycastle.util.encoders.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

<span class="nc" id="L46">public class SingleSignOnTest {</span>

<span class="nc" id="L48">    private static Logger logger             = LoggerFactory.getLogger(SingleSignOnTest.class);</span>

    // private static File publicKeyFile = new File(
    // &quot;/Development/Java/Single Sign On with Encryption(PGP)/PGP1D0.pkr&quot;);
    // private static File privateKeyFile = new File(
    // &quot;/Development/Java/Single Sign On with Encryption(PGP)/PGP1D0.skr&quot;);
<span class="nc" id="L54">    private static String privateKeyPassword = &quot;passphrase&quot;;</span>

    //
    // Public class method decrypt
    //
    public static String decrypt(final byte[] encdata) {

<span class="nc" id="L61">        SingleSignOnTest.logger.info(&quot;decrypt(): data length = {}&quot;, Integer.valueOf(encdata.length));</span>
        // ----- Decrypt the file
        try {
<span class="nc" id="L64">            final ByteArrayInputStream bais = new ByteArrayInputStream(encdata);</span>
            // FileInputStream privKey = new FileInputStream(privateKeyFile);
<span class="nc" id="L66">            final TestKeyGen testKeyGen = new TestKeyGen();</span>
<span class="nc" id="L67">            final PGPSecretKey key = testKeyGen.createSecretKey(&quot;jeremylandis@hotmail.com&quot;, &quot;testme&quot;.toCharArray())</span>
<span class="nc" id="L68">                    .getSecretKey();</span>
<span class="nc" id="L69">            final FileInputStream privKey = new FileInputStream(key.toString());</span>
<span class="nc" id="L70">            final String result = SingleSignOnTest._decrypt(bais, privKey,</span>
<span class="nc" id="L71">                    SingleSignOnTest.privateKeyPassword.toCharArray());</span>
<span class="nc" id="L72">            privKey.close();</span>
<span class="nc" id="L73">            return result;</span>
<span class="nc" id="L74">        } catch (final Exception e) {</span>
<span class="nc" id="L75">            SingleSignOnTest.logger.error(e.getMessage());</span>
<span class="nc" id="L76">            SingleSignOnTest.logger.error(e.toString());</span>
        }
<span class="nc" id="L78">        return null;</span>

    }

    //
    // Public class method encrypt
    //
    public static byte[] encrypt(final byte[] data) {

        try {
            // ----- Read in the public key
            // PGPPublicKey key = readPublicKeyFromCol(new FileInputStream(
            // publicKeyFile));
<span class="nc" id="L91">            final TestKeyGen testKeyGen = new TestKeyGen();</span>
<span class="nc" id="L92">            final PGPPublicKey key = testKeyGen.createPublicKey(&quot;jeremylandis@hotmail.com&quot;, &quot;testme&quot;.toCharArray())</span>
<span class="nc" id="L93">                    .getPublicKey();</span>
<span class="nc" id="L94">            SingleSignOnTest.logger.info(&quot;Creating a temp file...&quot;);</span>
            // create a file and write the string to it
<span class="nc" id="L96">            final File tempfile = File.createTempFile(&quot;pgp&quot;, null);</span>
<span class="nc" id="L97">            final FileOutputStream fos = new FileOutputStream(tempfile);</span>
<span class="nc" id="L98">            fos.write(data);</span>
<span class="nc" id="L99">            fos.close();</span>
<span class="nc" id="L100">            SingleSignOnTest.logger.info(&quot;Temp file created at &quot;);</span>
<span class="nc" id="L101">            SingleSignOnTest.logger.info(tempfile.getAbsolutePath());</span>
<span class="nc" id="L102">            SingleSignOnTest.logger</span>
<span class="nc" id="L103">                    .info(&quot;Reading the temp file to make sure that the bits were written\n--------------&quot;);</span>
<span class="nc" id="L104">            final BufferedReader isr = new BufferedReader(new FileReader(tempfile));</span>
<span class="nc" id="L105">            String line = &quot;&quot;;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            while ((line = isr.readLine()) != null) {</span>
<span class="nc" id="L107">                SingleSignOnTest.logger.info(line + &quot;\n&quot;);</span>
            }
<span class="nc" id="L109">            isr.close();</span>
            // find out a little about the keys in the public key ring
<span class="nc" id="L111">            System.out.println(&quot;Key Strength = &quot; + key.getBitStrength());</span>
<span class="nc" id="L112">            System.out.println(&quot;Algorithm = &quot; + key.getAlgorithm());</span>
<span class="nc" id="L113">            System.out.println(&quot;Bit strength = &quot; + key.getBitStrength());</span>
<span class="nc" id="L114">            System.out.println(&quot;Version = &quot; + key.getVersion());</span>
<span class="nc" id="L115">            System.out.println(&quot;Encryption key = &quot; + key.isEncryptionKey() + &quot;, Master key = &quot; + key.isMasterKey());</span>
<span class="nc" id="L116">            int count = 0;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            for (final Iterator&lt;?&gt; iterator = key.getUserIDs(); iterator.hasNext();) {</span>
<span class="nc" id="L118">                count++;</span>
<span class="nc" id="L119">                System.out.println((String) iterator.next());</span>
            }
<span class="nc" id="L121">            SingleSignOnTest.logger.info(&quot;Key Count = &quot; + count);</span>
            // create an armored ascii file
            // FileOutputStream out = new FileOutputStream(outputfile);
            // encrypt the file
            // encryptFile(tempfile.getAbsolutePath(), out, key);
            // Encrypt the data
<span class="nc" id="L127">            final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L128">            SingleSignOnTest._encrypt(tempfile.getAbsolutePath(), baos, key);</span>
<span class="nc" id="L129">            System.out.println(&quot;encrypted text length=&quot; + baos.size());</span>
<span class="nc" id="L130">            tempfile.delete();</span>
<span class="nc" id="L131">            return baos.toByteArray();</span>
<span class="nc" id="L132">        } catch (final PGPException e) {</span>
<span class="nc" id="L133">            SingleSignOnTest.logger.error(e.getUnderlyingException().toString());</span>
<span class="nc" id="L134">            SingleSignOnTest.logger.error(e.toString());</span>
<span class="nc" id="L135">        } catch (final Exception e) {</span>
<span class="nc" id="L136">            SingleSignOnTest.logger.error(e.toString());</span>
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">        return null;</span>

    }

    // //
    // // Private class method readPublicKeyFromCol
    // //
    // private static PGPPublicKey readPublicKeyFromCol(InputStream in)
    // throws Exception {
    //
    // PGPPublicKeyRing pkRing = null;
    // PGPPublicKeyRingCollection pkCol = new PGPPublicKeyRingCollection(in);
    // System.out.println(&quot;key ring size=&quot; + pkCol.size());
    // Iterator&lt;?&gt; it = pkCol.getKeyRings();
    // while (it.hasNext()) {
    // pkRing = (PGPPublicKeyRing) it.next();
    // Iterator&lt;?&gt; pkIt = pkRing.getPublicKeys();
    // while (pkIt.hasNext()) {
    // PGPPublicKey key = (PGPPublicKey) pkIt.next();
    // SingleSignOnTest.logger.info(
    // &quot;Encryption key = {}, Master key = {}&quot;,
    // key.isEncryptionKey(), key.isMasterKey());
    // if (key.isEncryptionKey())
    // return key;
    // }
    // }
    // return null;
    //
    // }

    //
    // Public main method
    //
    public static void main(final String[] args) {

<span class="nc" id="L173">        Security.addProvider(new BouncyCastleProvider());</span>

<span class="nc" id="L175">        final String TOKEN = &quot;aamine&quot;;</span>

        // ----- Encrypt the message to a file them
<span class="nc" id="L178">        final byte[] encdata = SingleSignOnTest.encrypt(TOKEN.getBytes());</span>
<span class="nc" id="L179">        SingleSignOnTest.logger.info(&quot;Encrypted: {}&quot;, encdata);</span>

        // Encode the byte array to a string
<span class="nc" id="L182">        final byte[] temp = Base64.encode(encdata);</span>
<span class="nc" id="L183">        SingleSignOnTest.logger.info(&quot;Temp: {}&quot;, temp);</span>

        // us
<span class="nc" id="L186">        byte[] newB = null;</span>
        try {
<span class="nc" id="L188">            newB = Base64.decode(temp);</span>
<span class="nc" id="L189">        } catch (final Exception e) {</span>
<span class="nc" id="L190">            SingleSignOnTest.logger.info(&quot;Exception: {}&quot;, e);</span>
<span class="nc" id="L191">            return;</span>
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">        SingleSignOnTest.logger.info(&quot;byte array {}&quot;, Integer.valueOf(newB.length));</span>

<span class="nc" id="L195">        final String result = SingleSignOnTest.decrypt(newB);</span>
<span class="nc" id="L196">        SingleSignOnTest.logger.info(&quot;Decrypted: {}&quot;, result);</span>

<span class="nc" id="L198">    }</span>

    //
    // Private class method _decrypt
    //
    private static String _decrypt(final InputStream inputStream, final InputStream keyIn, final char[] passwd)
            throws Exception {

<span class="nc" id="L206">        final InputStream in = PGPUtil.getDecoderStream(inputStream);</span>
        try {
<span class="nc" id="L208">            final PGPObjectFactory pgpF = new BcPGPObjectFactory(in);</span>
            PGPEncryptedDataList enc;
<span class="nc" id="L210">            final Object o = pgpF.nextObject();</span>

            //
            // the first object might be a PGP marker packet.
            //
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (o instanceof PGPEncryptedDataList) {</span>
<span class="nc" id="L216">                enc = (PGPEncryptedDataList) o;</span>
            } else {
<span class="nc" id="L218">                enc = (PGPEncryptedDataList) pgpF.nextObject();</span>
            }

            //
            // find the secret key
            //
<span class="nc" id="L224">            final Iterator&lt;?&gt; it = enc.getEncryptedDataObjects();</span>
<span class="nc" id="L225">            PGPPrivateKey sKey = null;</span>
<span class="nc" id="L226">            PGPPublicKeyEncryptedData pbe = null;</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">            while (sKey == null &amp;&amp; it.hasNext()) {</span>
<span class="nc" id="L228">                pbe = (PGPPublicKeyEncryptedData) it.next();</span>
<span class="nc" id="L229">                SingleSignOnTest.logger.info(&quot;pbe id = {}&quot;, Long.valueOf(pbe.getKeyID()));</span>
<span class="nc" id="L230">                sKey = SingleSignOnTest.findSecretKey(keyIn, pbe.getKeyID(), passwd);</span>
            }
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (sKey == null) {</span>
<span class="nc" id="L233">                in.close();</span>
<span class="nc" id="L234">                throw new IllegalArgumentException(&quot;secret key for message not found.&quot;);</span>
            }
<span class="nc" id="L236">            final BcPublicKeyDataDecryptorFactory factory = new BcPublicKeyDataDecryptorFactory(sKey);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            final InputStream clear = pbe != null ? pbe.getDataStream(factory) : null;</span>
<span class="nc" id="L238">            final PGPObjectFactory plainFact = new BcPGPObjectFactory(clear);</span>
<span class="nc" id="L239">            Object message = plainFact.nextObject();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            if (message instanceof PGPCompressedData) {</span>
<span class="nc" id="L241">                final PGPCompressedData cData = (PGPCompressedData) message;</span>
<span class="nc" id="L242">                final PGPObjectFactory pgpFact = new BcPGPObjectFactory(cData.getDataStream());</span>
<span class="nc" id="L243">                message = pgpFact.nextObject();</span>
            }
<span class="nc" id="L245">            final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (message instanceof PGPLiteralData) {</span>
<span class="nc" id="L247">                final PGPLiteralData ld = (PGPLiteralData) message;</span>
<span class="nc" id="L248">                final InputStream unc = ld.getInputStream();</span>
                int ch;
<span class="nc bnc" id="L250" title="All 2 branches missed.">                while ((ch = unc.read()) &gt;= 0) {</span>
<span class="nc" id="L251">                    baos.write(ch);</span>
                }
<span class="nc" id="L253">                unc.close();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            } else if (message instanceof PGPOnePassSignatureList) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (clear != null) {</span>
<span class="nc" id="L256">                    clear.close();</span>
                }
<span class="nc" id="L258">                throw new PGPException(&quot;encrypted message contains a signed message - not literal data.&quot;);</span>
            } else {
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (clear != null) {</span>
<span class="nc" id="L261">                    clear.close();</span>
                }
<span class="nc" id="L263">                throw new PGPException(&quot;message is not a simple encrypted file - type unknown.&quot;);</span>
            }
<span class="nc bnc" id="L265" title="All 4 branches missed.">            if (pbe != null &amp;&amp; pbe.isIntegrityProtected()) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                if (!pbe.verify()) {</span>
<span class="nc" id="L267">                    SingleSignOnTest.logger.error(&quot;message failed integrity check&quot;);</span>
                } else {
<span class="nc" id="L269">                    SingleSignOnTest.logger.error(&quot;message integrity check passed&quot;);</span>
                }
            } else {
<span class="nc" id="L272">                SingleSignOnTest.logger.error(&quot;no message integrity check&quot;);</span>
            }
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (clear != null) {</span>
<span class="nc" id="L275">                clear.close();</span>
            }
<span class="nc" id="L277">            return baos.toString();</span>
<span class="nc" id="L278">        } catch (final PGPException e) {</span>
<span class="nc" id="L279">            System.err.println(e);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (e.getUnderlyingException() != null) {</span>
<span class="nc" id="L281">                e.getUnderlyingException().printStackTrace();</span>
            }
        }
<span class="nc" id="L284">        in.close();</span>
<span class="nc" id="L285">        return null;</span>

    }

    //
    // Private class method _encrypt
    //
    private static void _encrypt(final String fileName, final OutputStream outputStream, final PGPPublicKey encKey)
            throws IOException, PGPException {

<span class="nc" id="L295">        final OutputStream out = new DataOutputStream(outputStream);</span>
<span class="nc" id="L296">        final ByteArrayOutputStream bOut = new ByteArrayOutputStream();</span>
<span class="nc" id="L297">        SingleSignOnTest.logger.info(&quot;creating comData...&quot;);</span>
        // get the data from the original file
<span class="nc" id="L299">        final PGPCompressedDataGenerator comData = new PGPCompressedDataGenerator(CompressionAlgorithmTags.ZIP);</span>
<span class="nc" id="L300">        PGPUtil.writeFileToLiteralData(comData.open(bOut), PGPLiteralData.BINARY, new File(fileName));</span>
<span class="nc" id="L301">        comData.close();</span>
<span class="nc" id="L302">        SingleSignOnTest.logger.info(&quot;comData created...&quot;);</span>
<span class="nc" id="L303">        SingleSignOnTest.logger.info(&quot;using PGPEncryptedDataGenerator...&quot;);</span>
        // object that encrypts the data
<span class="nc" id="L305">        final BcPGPDataEncryptorBuilder builder = new BcPGPDataEncryptorBuilder(SymmetricKeyAlgorithmTags.CAST5);</span>
<span class="nc" id="L306">        final PGPEncryptedDataGenerator cPk = new PGPEncryptedDataGenerator(builder);</span>
<span class="nc" id="L307">        final BcPublicKeyKeyEncryptionMethodGenerator generator = new BcPublicKeyKeyEncryptionMethodGenerator(encKey);</span>
<span class="nc" id="L308">        cPk.addMethod(generator);</span>
<span class="nc" id="L309">        SingleSignOnTest.logger.info(&quot;used PGPEncryptedDataGenerator...&quot;);</span>
        // take the outputstream of the original file and turn it into a byte
        // array
<span class="nc" id="L312">        final byte[] bytes = bOut.toByteArray();</span>
<span class="nc" id="L313">        SingleSignOnTest.logger.info(&quot;wrote bOut to byte array...&quot;);</span>
        // write the plain text bytes to the armored outputstream
<span class="nc" id="L315">        final OutputStream cOut = cPk.open(out, bytes.length);</span>
<span class="nc" id="L316">        cOut.write(bytes);</span>
<span class="nc" id="L317">        cOut.close();</span>
<span class="nc" id="L318">        cPk.close();</span>
<span class="nc" id="L319">        out.close();</span>
<span class="nc" id="L320">    }</span>

    //
    // Private class method findSecretKey
    //
    private static PGPPrivateKey findSecretKey(final InputStream keyIn, final long keyID, final char[] pass)
            throws IOException, PGPException {

<span class="nc" id="L328">        final PGPSecretKeyRingCollection pgpSec = new BcPGPSecretKeyRingCollection(PGPUtil.getDecoderStream(keyIn));</span>
<span class="nc" id="L329">        final PGPSecretKey pgpSecKey = pgpSec.getSecretKey(keyID);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (pgpSecKey == null) {</span>
<span class="nc" id="L331">            return null;</span>
        }
<span class="nc" id="L333">        return pgpSecKey.extractPrivateKey(new BcPBESecretKeyDecryptorBuilder(new BcPGPDigestCalculatorProvider())</span>
<span class="nc" id="L334">                .build(pass));</span>

    }

    //
    // Public class method readFile
    //
    public byte[] readFile(final File file) throws IOException {

<span class="nc" id="L343">        final BufferedInputStream fis = new BufferedInputStream(new FileInputStream(file));</span>
<span class="nc" id="L344">        final byte[] buf = new byte[8192];</span>
<span class="nc" id="L345">        int numRead = 0;</span>
<span class="nc" id="L346">        final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        while ((numRead = fis.read(buf)) &gt; 0) {</span>
<span class="nc" id="L348">            baos.write(buf, 0, numRead);</span>
        }
<span class="nc" id="L350">        fis.close();</span>
<span class="nc" id="L351">        final byte[] returnVal = baos.toByteArray();</span>
<span class="nc" id="L352">        baos.close();</span>
<span class="nc" id="L353">        return returnVal;</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>